<script src="https://code.jquery.com/jquery-2.2.3.js" integrity="sha256-laXWtGydpwqJ8JA+X9x2miwmaiKhn8tVmOVEigRNtP4=" crossorigin="anonymous"></script>
<script src="lodash.js"></script>
<script type="text/javascript" src="jquery-1.12.2.js"></script>
<script type="text/javascript" src="classroom.js"></script>
<link href='https://fonts.googleapis.com/css?family=Cabin:400,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css">

<style>
body, html {
  font: 28px Cabin;
  width: 100%;
  height: 100%;
}
table {
    margin: auto;
    width: 60%;
    border-collapse: collapse;
}
table td.student_name {
    width: 20%;
}
table td {
    width: 38%;
    vertical-align: top;
    border: 1px solid gray;
    padding: 2px 2px;
}
table th {
    font-weight: normal;
    font-size: 22px;
}

table td.remove {
    width: 4%;
    vertical-align: middle;
    text-align: center;
}

table td.remove:before {
    font-family: FontAwesome;
    content: '\f014';
}

table td p {
    display: inline-block;
    border: 1px solid;
    border-radius: 5px;
    padding: 3px 7px;
    margin: 1px 3px;
}

table td p span:after {
    font-family: FontAwesome;
    content: ' \f00d';
}

table td p span:hover {
    color: red;
}

table td textarea {
    width: 100%;
    font: 18px Cabin;
}
</style>
<body>
    <table class="classroom">
      <thead>
        <tr>
            <th>Student</th><th>Pair With</th><th>Don't Pair With</th><th></th>
        </tr>
      </thead>
      <tbody>
      </tbody>

    </table>
</body>
<script>

/**
var studentNames = ["Berk Ustun", "Nick M.", "David Bau", 
                    "Frederick", "George W.", "Shruti", 
                    "Rita", "Wendy", "Jenna", "Alice",
                    "Xin", "Will", "D'Angelo", "Kobe"]
                    
function sampleName(){
    return _.sample(studentNames)
}

function samplePreferences(nSamples){
    if (nSamples == null){
        var nSamples = Math.min(Math.floor(Math.random()*studentNames.length), 2);
    }
    return _.sampleSize(studentNames, nSamples);
}
**/

  var parseStudentList = function() {
    var student_list = $("#newstudentbox").val();
    console.log(student_list);
    student_list = student_list.replace(/\n/g, '1)(*3hf:Z');
    student_list = student_list.split('1)(*3hf:Z');
    console.log(student_list);
    var l = [];
    for (var i=0; i<student_list.length; i++) {
        var student_list2 = student_list[i].replace(/\t/g, '1)(*3hf:Z');
        student_list2 = student_list2.split('1)(*3hf:Z');
        console.log(student_list2);
        if (student_list2.length == 1) {
            var l2 = student_list2[0].split(",");
            for (var k=0; k<l2.length; k++){
                l.push({name:l2[k], prefer: [], avoid: []});
            }
        }
        else if (student_list2.length == 2) {
            l.push({name: student_list2[0], prefer:student_list2[1].split(",")});
        }
        else {
            l.push({name: student_list2[0], prefer:student_list2[1].split(","), avoid:student_list2[2].split(",")});
        }

    }
/**
    student_list = student_list.replace(/\n/g, ',');
    student_list = student_list.replace(/\t/g, ',');
    student_list = student_list.replace(/;/g, ',');
    var student_array = student_list.split(",");**/
    for (var i = 0; i < l.length; i++) {
      if (classroom.findStudentNamed(l[i].name.trim()) == null) {
        if (l[i].name.trim() != "") {
          classroom.addStudent({name: l[i].name.trim(), avoid: l[i].avoid, prefer: l[i].prefer});
        }
      }
    }
  };

var loadTable = function(classroom) {
    $('table tbody').empty()
    for (var i = 0; i < classroom.getStudentCount(); i++) {
        addRow(classroom.getStudent(i));
    }
    addLastRow();
    $("#newstudentbox").focus();
}

function addRow(student) {
    var row = $('<tr>');
    $('<td class="student_name">').appendTo(row).html('<p>' + student.name +'</p>')

    var preferhtml = ""
    for (i = 0; i < student.prefer.length; i++) {
        preferhtml += '<p>' + student.prefer[i] + '<span class="removeprefer" id="'+student.prefer[i]+"*#95f%:"+student.sid+'"></span></p>'
    }


    var avoidhtml = ""
    for (i = 0; i < student.avoid.length; i++) {
        console.log(student.avoid[i]);
        console.log(student.sid);
        avoidhtml += '<p>' + student.avoid[i] + '<span class="removeavoid" id="'+student.avoid[i]+"*#95f%:"+student.sid+'"></span></p>'
    }

    $('<td class="pair_with">').appendTo(row).html(preferhtml);
    $('<td class="dont_pair_with">').appendTo(row).html(avoidhtml);

/**
    $('<td class="pair_with">').appendTo(row).html(
        samplePreferences().map(function(student.prefer) { return '<p>' + student.prefer + '<span></span></p>'; }).join(' ')
    );

    $('<td class="dont_pair_with">').appendTo(row).html(
        samplePreferences().map(function(student.avoid) { return '<p>' + student.avoid + '<span></span></p>'; }).join(' ')
    );
**/

    $('<td id="'+student.sid+'" class="remove">').appendTo(row);
    $('table tbody').append(row);
}

function addLastRow() {
    var row = $('<tr>');
    $('<td class="student_name" colspan="4">').appendTo(row).html('<textarea id= "newstudentbox" placeholder="Enter new student names"></textarea>');
    $('table tbody').append(row);
}

//HANDLE COPY PASTING  http://stackoverflow.com/questions/3211505/detect-pasted-text-with-ctrlv-or-right-click-paste
function getTextAreaSelection(textarea) {
    var start = textarea.selectionStart, end = textarea.selectionEnd;
    return {
        start: start,
        end: end,
        length: end - start,
        text: textarea.value.slice(start, end)
    };
}

function detectPaste(textarea, callback) {
    textarea.onpaste = function() {
        var sel = getTextAreaSelection(textarea);
        var initialLength = textarea.value.length;
        window.setTimeout(function() {
            var val = textarea.value;
            var pastedTextLength = val.length - (initialLength - sel.length);
            var end = sel.start + pastedTextLength;
            callback({
                start: sel.start,
                end: end,
                length: pastedTextLength,
                text: val.slice(sel.start, end)
            });
        }, 1);
    };
}
/**
var textarea = document.getElementById("your_textarea");
detectPaste(textarea, function(pasteInfo) {
    alert(pasteInfo.text);
    // pasteInfo also has properties for the start and end character
    // index and length of the pasted text
});
**/
$(document).ready(function() {

    classroom = new Classroom();

    loadTable(classroom);    

        /**
    classroom.addStudent({name: "Amy", avoid: ["Susan", "Pat"], prefer: []});
    classroom.addStudent({name: "Bob", avoid: ["Susan", "Pat"], prefer: ["Amy"]});
**/
    $("#preferenceButton").click(function(e) {
      toggleView();
      toggleButtonText();
  });

    $(document).on('click', ".remove", function(e) {
      console.log('removal detected');
      var student_id = $(this).attr('id');
      console.log(student_id);
      classroom.removeStudent(student_id);
    });

    $(document).on('click', ".removeprefer", function(e) {
        var removedata = $(this).attr('id').split("*#95f%:");
        var sid = removedata[1];
        var removal_name = removedata[0];
        for (var  i = 0; i < classroom.getStudentCount(); i++){
            if (classroom.getStudent(i).sid == sid) {
                for (var j = 0; j < classroom.getStudent(i).prefer.length; j++) {
                    if (classroom.getStudent(i).prefer[j] == removal_name ){
                        classroom.getStudent(i).prefer.splice(j, 1);
                        loadTable(classroom);
                    }
                }
            }
        }
    });

    $(document).on('click', ".removeavoid", function(e) {
        var removedata = $(this).attr('id').split("*#95f%:");
        var sid = removedata[1];
        var removal_name = removedata[0];
        for (var  i = 0; i < classroom.getStudentCount(); i++){
            if (classroom.getStudent(i).sid == sid) {
                for (var j = 0; j < classroom.getStudent(i).avoid.length; j++) {
                    if (classroom.getStudent(i).avoid[j] == removal_name ){
                        classroom.getStudent(i).avoid.splice(j, 1);
                        loadTable(classroom);
                    }
                }
            }
        }
    });

    //$(document).on('click', "#groupem", parseStudentList());

    $(document).on('keyup', "#newstudentbox", function(e) {
      if (e.which == 13) {
        parseStudentList();
        $("#newstudentbox").val("");
      }
    })

    $(classroom).on('changestudents', function() {
        console.log('loading');
      loadTable(classroom);
  });

    $(document).on('paste', "#newstudentbox", function(e) {
        var pastedata = $(this).val();

    });

});
</script>
