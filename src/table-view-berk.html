<meta charset='utf-8'>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="../external_js/lodash.js"></script>
<script src="../external_js/jquery-1.12.2.js"></script>
<script src="../external_js/jquery-ui.js"></script>
<script src="../src/classlist.js"></script>
<script src="../src/student.js"></script>
<link rel="stylesheet" href="../src/sidebar.css">
<!-- <link rel="stylesheet" href='https://fonts.googleapis.com/css?family=Cabin:400,700'> -->
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>
<link rel='stylesheet' href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css">
<link rel='stylesheet' href="../src/table-view-berk.css">

<body>
<div class="sidebar">
<div style="position: relative; text-align: center; margin: 30px 0; height:150px; ">
<img src="../images/logo_1.png" width=180 >

</div>
<div id='cssmenu'>
<ul>
   <li class='active'><a href='#'><span>Creation</span></a></li>
   <li class='last'><a href='group-view.html'><span>Groups</span></a></li>
</ul>
</div>
</div>

<div class="content">
<table class="classroom">
<thead>
<tr>
<th id="classname_row" colspan="4">
<input type="text" id="classname_input"></input>
</th>
</tr>
<tr>
  <th unselectable="on" class="student_name">Student</th>
  <th unselectable="on" class="pair_with">Pair With</th>
  <th unselectable="on" class="dont_pair_with">Don't Pair With</th>
  <th unselectable="on" class="remove"></th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<th id='add_student_row' colspan="4">
  <textarea id="add_student_box"></textarea>
</th>
</tr>
<tr>

<th id="button_row" colspan="4">
<div id="button_container">
<div id="groupem_container">
<button id="groupem_button" class="control_button" disabled>group'em</button>
</div>
<div id="group_size_container">
<input id="group_size_input" placeholder="2"></input>
</div>
<div id="increment_container">
<div id="increase_button_container"><button id="increase_group_size" class="increment_button"></button></div>
<div id="decrease_button_container"><button id="decrease_group_size" class="increment_button"></button></div>
</div>
</div>
</th>

</tr>
</tfoot>
</table>
</body>

<script>
var ADD_CLASSNAME_PLACEHOLDER = "enter class name"
var ADD_STUDENT_BOX_PLACEHOLDER = "enter students or copy/paste student list"
var REVERT_SPEED_DURATION = 500;

//
var parseStudentList = function() {
  var student_list = $("#add_student_box").val();
  // console.log(student_list);
  student_list = student_list.replace(/\n/g, '1)(*3hf:Z');
  student_list = student_list.split('1)(*3hf:Z');
  
  var studentArray = [];
  var nextStudentID = classroom.getNextStudentID();
  // console.log(nextStudentID);

  for (var i=0; i<student_list.length; i++) {
    var row_list = student_list[i].replace(/\t/g, '1)(*3hf:Z');
    row_list = row_list.split('1)(*3hf:Z');
    console.log(row_list);
    if (row_list.length == 1) {
      row_list[0] = row_list[0].replace(/;/g, ',');
      var name_list = row_list[0].split(",");
      for (var k=0; k< name_list.length; k++){
        var studentName = name_list[k].trim();
        if (studentName.length > 0){
          studentArray.push(new Student(studentName, nextStudentID));
          nextStudentID++;
        }
      }
    } else if (row_list.length == 2) {
      studentArray.push(new Student(row_list[0], nextStudentID));
      nextStudentID++;
      // final_data.push({
      //   name: row_list[0],
      //    prefer:row_list[1].split(",").map(function (str) {return str.trim();}).filter(function(str) {return str != ""})
      // });
    } else {
        studentArray.push(new Student(row_list[0], nextStudentID));
        nextStudentID++;
        //   name: row_list[0],
      //    prefer:row_list[1].split(",").map(function (str) {return str.trim();}).filter(function(str) {return str != ""}),
      //    avoid:row_list[2].split(",").map(function (str) {return str.trim();}).filter(function(str) {return str != ""})
      // });
      }
    }
  console.log(studentArray)
  return studentArray;
}

//redraws table at each state change
var updateTable = function(classroom) {
  $('table tbody').empty();
  if (classroom.getSize() > 0){
    // console.log(classroom.toString())
    var studentArray = classroom.getStudents();
    for (var i = 0; i < studentArray.length; i++) {
      addRow(studentArray[i]);
    }
    $("#groupem_button").prop('disabled', false);
  } else {
    $("#groupem_button").prop('disabled', true);
  }
}

function getTileHTML(name, type, tileID, tileClasses){
  var tileHTML = "<p"
  if (tileID != null){
    tileHTML += " id= '" + tileID + "'";
  }
  if (tileClasses != null){
    tileHTML += " class= 'tile ";
    for (var i = 0; i < tileClasses.length; i++){
      tileHTML += tileClasses[i] + " ";
    }
    tileHTML += "'";
  }
  tileHTML += ">"
  tileHTML += "<i class='fa fa-grip'></i>" + name 
  if (type == "prefer") {
      tileHTML += "<span class='removePreferTile'></span>"
  } else if (type == "avoid") {
      tileHTML += "<span class='removeAvoidTile'></span>"
  }
  tileHTML += "</p>"
  return tileHTML
}

//class names and IDs
//tile_name_[SID1]: ID for tile with student SID1 in "student_name" column
//tile_prefer_[SID1]_[SID2]: ID for tile with student SID2 in "prefer" column of student [SID1]
//tile_avoid_[SID1]_[SID2]: ID for tile with student SID2 in "avoid" column of student [SID1]
//class: tile_[SID] : class name for any tile student SID name on it 
function addRow(student) {
  
  //get new student ID
  var studentID = student.id();
  var studentName = student.name();
  // console.log(student.toString())
  
  //define IDs for table row and cell
  var rowID = "row_" + studentID;
  var nameID = "name_cell_" + studentID;
  var preferID = "prefer_cell_" + studentID;
  var avoidID = "avoid_cell_" + studentID;
  var removeID = 'delete_cell_' + studentID;

  //define jQuery selectors for table row and each cell
  var row = "#" + rowID;
  var nameCell = "#" + nameID
  var preferCell = "#" + preferID
  var avoidCell = "#" + avoidID
  var removeCell = "#" + removeID
  
  //add new row + cells
  $('table tbody').append('<tr id = ' + rowID +'></tr>');
  $(row).append("<td class='student_name' id=" + nameID + "></td>")
  $(row).append("<td class='pair_with' id=" + preferID + "></td>")
  $(row).append("<td class='dont_pair_with' id=" + avoidID + "></td>")
  $(row).append("<td class='remove' id=" + removeID + "></td>")  

  //add name tile
  var tileID  = "tile_name_" + studentID;
  var tileHTML = getTileHTML(studentName, "name", tileID, ["tile_name"])
  $(nameCell).append(tileHTML)

  //add pair with tiles
  var prefIDs = student.getPreferences('prefer');
  for (i = 0; i < prefIDs.length; i++) {
    var targetStudent = classroom.getStudentFromID(prefIDs[i]);
    var tileID = "tile_prefer_" + studentID + "_" + prefIDs[i];
    var tileClasses = ["tile_prefer", "tile_" + prefIDs[i]];
    var tileHTML = getTileHTML(targetStudent.name(), "prefer", tileID, tileClasses)
    $(preferCell).append(tileHTML);
    console.log('adding '  + tileHTML + 'to ' + preferCell)
    $("#" + tileID).data('studentID', prefIDs[i]);
    // $("#" + tileID).data('targetID', );
  }

  //add don't pair with tiles
  var avoidIDs =  student.getPreferences('avoid');
  for (i = 0; i < avoidIDs.length; i++) {
    var targetStudent = classroom.getStudentFromID(avoidIDs[i]);
    var tileID = "tile_avoid_" + studentID + "_" + avoidIDs[i];
    var tileClasses = ["tile_avoid", "tile_" + avoidIDs[i]];
    var tileHTML = getTileHTML(targetStudent.name(), "avoid", tileID, tileClasses);
    $(avoidCell).append(tileHTML);
    $("#" + tileID).data('studentID', avoidIDs[i]);
    // $("#" + tileID).data('targetID', );
    // console.log("#" + tileID)
  }

  //add data to all other elements
  $(row).data("studentID", studentID)
  $(preferCell).data('studentID', studentID)
  $(nameCell).data("studentID", studentID)
  $(avoidCell).data("studentID", studentID)
  $(removeCell).data("studentID", studentID)
}

//HANDLE COPY PASTING  http://stackoverflow.com/questions/3211505/detect-pasted-text-with-ctrlv-or-right-click-paste
function getTextAreaSelection(textarea) {
  var start = textarea.selectionStart, end = textarea.selectionEnd;
  return {
    start: start,
    end: end,
    length: end - start,
    text: textarea.value.slice(start, end)
  };
}

function detectPaste(textarea, callback) {
  textarea.onpaste = function() {
    var sel = getTextAreaSelection(textarea);
    var initialLength = textarea.value.length;
    window.setTimeout(function() {
      var val = textarea.value;
      var pastedTextLength = val.length - (initialLength - sel.length);
      var end = sel.start + pastedTextLength;
      callback({
        start: sel.start,
        end: end,
        length: pastedTextLength,
        text: val.slice(sel.start, end)
      });
    }, 1);
  };
}

function loadClassroomFromLocalStorage(classroom) {
  try {
    var json_classroom = JSON.parse(localStorage.getItem('stored_classroom'));
    var student_list = json_classroom.studentList;
    for (var s = 0; s < student_list.length; s++) {
      classroom.addStudent(new Student(s, student_list[s]));
    }
  } catch (e) {
    console.log('Could not load the classroom ' + e);
  }
}

/**
  var textarea = document.getElementById("your_textarea");
  detectPaste(textarea, function(pasteInfo) {
  alert(pasteInfo.text);
// pasteInfo also has properties for the start and end character
// index and length of the pasted text
});
 **/
$(document).ready(function() {
  classroom = new Classlist();
  
  $(document).on('click', ".remove", function(e) {
    var removedStudentID = $(this).data('studentID');
    console.log('user tried to delete student : ' + removedStudentID);
    var update_flag = classroom.remove(removedStudentID); //remove student from model + preferences
    if (update_flag){
      // var rowID = "#row_" + removedStudentID;
      // $(rowID).remove();
      // var tileClass = ".tile_" + removedStudentID;
      // $(tileClass).remove();
      updateTable(classroom)
      //alternatively, you could also do updateTable(classroom) to redraw the table
    }
  });

  $(document).on('click', ".removePreferTile", function(e) {
    var rowStudentID = $(this).closest('td').data('studentID');
    var tileStudentID = $(this).closest('p').data('studentID');
    var rowStudent = classroom.getStudentFromID(rowStudentID)
    var update_flag = rowStudent.removeFromPreferences('prefer', tileStudentID);
    if (update_flag){
      $(this).parent().remove()  
    } else {
      console.log('removal failed')
    }
  });

  $(document).on('click', ".removeAvoidTile", function(e) {
    console.log('user clicked remove tile in avoid column');
    var rowStudentID = $(this).closest('td').data('studentID');
    var tileStudentID = $(this).closest('p').data('studentID');
    var rowStudent = classroom.getStudentFromID(rowStudentID)
    var update_flag = rowStudent.removeFromPreferences('avoid', tileStudentID);
    if (update_flag){
      $(this).parent().remove()  
    } else {
      console.log('removal failed')
    }
  });

  $(classroom).on('changestudents', function() {
    localStorage.setItem('stored_classroom', JSON.stringify(classroom));
    // updateTable(classroom);
  });

  //input classname textbox placeholder listeners
  $("#classname_input").data('holder', ADD_CLASSNAME_PLACEHOLDER);
  $("#classname_input").on('focus', function(){
    $(this).attr('placeholder', '')
  });
  $("#classname_input").on('focusout', function(){
    $(this).attr('placeholder', $(this).data('holder'))
  });
  $("#classname_input").attr('placeholder', ADD_CLASSNAME_PLACEHOLDER);
  $(document).on('keyup', "#classname_input", function(e) {
    var charCode = event.which || event.keyCode;
    if (charCode == '13'){
      $('input').blur();
    }
  });

  //input student textbox placeholder listeners
  $("#add_student_box").data('holder', ADD_STUDENT_BOX_PLACEHOLDER)
  $("#add_student_box").on('focus', function(){
    $(this).attr('placeholder', '')
  });
  $("#add_student_box").on('focusout', function(){
    $(this).attr('placeholder',  $(this).data('holder'));
  });
  $("#add_student_box").attr('placeholder', ADD_STUDENT_BOX_PLACEHOLDER);

  //group'em button listener
  document.getElementById("groupem_button").onclick = function () {
    if (classroom.getSize() > 0){
      location.href = "group-view.html";
    } else {
      alert("should not get here")
    }
  };

  $(document).on('keyup', "#add_student_box", function(e) {
    var charCode = e.which || e.keyCode;
    if (charCode == '13'){
      console.log('user pressed enter on student box')
      var studentArray = parseStudentList();
      for (var i = 0; i < studentArray.length; i++){
        classroom.add(studentArray[i]);
      }
      $("#add_student_box").val("");
      updateTable(classroom);
      console.log(classroom)
    }
  });

  $(document).on('paste', "#add_student_box", function(e) {
    var pastedata = $(this).val();
  });

  //drag and drop behavior for name tiles
  $("table").on('mouseenter',".tile_name", function() {
    $(this).css( 'cursor', 'grabbing' );
    var todrag = $(this);
    var tileStudentID = todrag.parent().data("studentID")
    todrag.draggable({'helper': 'clone', 'revert': true, 'revertDuration': REVERT_SPEED_DURATION});

  $(".pair_with").droppable({
      accept: "p",
      drop: function(event, ui) {
        var targetStudentID = $(event.target).data("studentID");
        console.log("tile for " + tileStudentID + " was dropped in pair_with column for student " + targetStudentID);
        if (targetStudentID != tileStudentID){
          var targetStudent = classroom.getStudentFromID(targetStudentID);
            var update_flag = classroom.getStudentFromID(targetStudentID).addToPreferences('prefer', tileStudentID);
              if (update_flag){
                updateTable(classroom);
              } else {
                console.log('drop denied. preference must already exist.')
              }
        } else {
          console.log('user tried to drop tile in invalid cell')
        }
      }
    });

    $(".dont_pair_with").droppable({
      accept: "p",
      drop: function(event,ui) {
        var targetStudentID = $(this).data("studentID");
        console.log("tile for " + tileStudentID + " was dropped in dont_pair_with column for student " + targetStudentID);
        if (targetStudentID != tileStudentID){
          var targetStudent = classroom.getStudentFromID(targetStudentID);
            var update_flag = classroom.getStudentFromID(targetStudentID).addToPreferences('avoid', tileStudentID);
              if (update_flag){
                updateTable(classroom);
              } else {
                console.log('drop denied. preference must already exist.')
              }
          
        } else {
          console.log('user tried to drop tile in invalid cell')
        }
      }
    });
  });

    //drag and drop behavior for pair_with tiles
  $("table").on('mouseenter',".tile_prefer", function() {
    $(this).css( 'cursor', 'grabbing' );
    var todrag = $(this);
    var tileStudentID = todrag.data("studentID");
    var sourceStudentID = todrag.parent().data("studentID");

    console.log('PICKUP ID' + tileStudentID)
    todrag.draggable({revert: true});

  $(".pair_with").droppable({
      accept: "p",
      drop: function(event, ui) {
        var targetStudentID = $(this).data("studentID");
        console.log("tile for " + tileStudentID + " was picked up from " + sourceStudentID + " and dropped in pair_with column for student " + targetStudentID);
        if ((targetStudentID != tileStudentID) && (targetStudentID != sourceStudentID)){
          var successfulRemoval = classroom.getStudentFromID(sourceStudentID).removeFromPreferences('prefer', tileStudentID);
          var successfulAddition = classroom.getStudentFromID(targetStudentID).addToPreferences('prefer', tileStudentID);
              if (successfulRemoval && successfulAddition){
                updateTable(classroom);
              } else {
                console.log('drop could not be completed at the model level')
              }
        } else {
          console.log('user tried to drop tile in invalid cell')
        }
      }
    });

    $(".dont_pair_with").droppable({
      accept: "p",
      drop: function(event,ui) {
        var targetStudentID = $(this).data("studentID");
        console.log("tile for " + tileStudentID + " was picked up from " + sourceStudentID + " and dropped in dont_pair_with column for student " + targetStudentID);
        if (targetStudentID != tileStudentID) {
          var successfulAddition = classroom.getStudentFromID(sourceStudentID).removeFromPreferences('prefer', tileStudentID);
          var successfulRemoval = classroom.getStudentFromID(targetStudentID).addToPreferences('avoid', tileStudentID);
              if (successfulAddition && successfulRemoval){
                updateTable(classroom);
              } else {
                console.log('drop could not be completed at the model level')
              }
        } else {
          console.log('user tried to drop tile in invalid cell')
        }
      }
    });
  });

  //drag and drop behavior for dont_pair_with tiles
  $("table").on('mouseenter',".tile_avoid", function() {
    $(this).css( 'cursor', 'grabbing' );
    var todrag = $(this);
    var tileStudentID = todrag.data("studentID");
    var sourceStudentID = todrag.parent().data("studentID");

    console.log('PICKUP ID' + tileStudentID)
    todrag.draggable({revert: true});

  $(".pair_with").droppable({
      accept: "p",
      drop: function(event, ui) {
        var targetStudentID = $(this).data("studentID");
        console.log("tile for " + tileStudentID + " was picked up from " + sourceStudentID + " and dropped in pair_with column for student " + targetStudentID);
        if (targetStudentID != tileStudentID){
          var successfulRemoval = classroom.getStudentFromID(sourceStudentID).removeFromPreferences('avoid', tileStudentID);
          var successfulAddition = classroom.getStudentFromID(targetStudentID).addToPreferences('prefer', tileStudentID);
              if (successfulAddition && successfulRemoval){
                updateTable(classroom);
              } else {
                console.log('drop could not be completed at the model level')
              }
        } else {
          console.log('user tried to drop tile in invalid cell')
        }
      }
    });

    $(".dont_pair_with").droppable({
      accept: "p",
      drop: function(event,ui) {
        var targetStudentID = $(this).data("studentID");
        console.log("tile for " + tileStudentID + " was picked up from " + sourceStudentID + " and dropped in pair_with column for student " + targetStudentID);
        if ((targetStudentID != tileStudentID) && (targetStudentID != sourceStudentID)){
          var successfulRemoval = classroom.getStudentFromID(sourceStudentID).removeFromPreferences('avoid', tileStudentID);
          var successfulAddition = classroom.getStudentFromID(targetStudentID).addToPreferences('avoid', tileStudentID);
              if (successfulAddition && successfulRemoval){
                updateTable(classroom);
              } else {
                console.log('drop could not be completed at the model level')
              }
        } else {
          console.log('user tried to drop tile in invalid cell')
        }
      }
    });
  });

  // loadClassroomFromLocalStorage(classroom);
  // loadTable(classroom);
  
});

</script>
