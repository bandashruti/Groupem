<!DOCTYPE html>
<html>

<meta charset='utf-8'>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../src/sidebar.css">
<link href='https://fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>
<link rel='stylesheet' href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css">
<link rel='stylesheet' href='../src/group-view.css'>

<body>

<svg></svg>

<div class="sidebar">
<div style="position: relative; text-align: center; margin: 30px 0; height:150px; " >
<div id = "logo_container">
<div id = "logo_icon"></div>
<div id = 'logo_name'></div>
</div>
</div>
<div id='cssmenu'>
<ul>
   <li class='last' ><a id='link_to_table_view' href='table-view.html'></a></li>
   <li class='active'><a id='link_to_group_view' href='#'></a></li>
</ul>
</div>
</div>


<div id="control_container">
<div id="button_container">
<button id="shuffle_button" class="control_button" type="button">shuffle</button>
</div>
<div id="group_size_container">
<input id="group_size_input" disabled></input>
</div>
<div id="increment_container">
<div id="increase_button_container"><button id="increase_group_size" class="increment_button control_button"></button></div>
<div id="decrease_button_container"><button id="decrease_group_size" class="increment_button control_button"></button></div>
</div>
</div>


<script src="../external_js/lodash.js"></script>
<script src="../external_js/d3.js"></script>
<script src="../external_js/jquery-1.12.2.js"></script>

<script src="../src/classlist.js"></script>
<script src="../src/student.js"></script>
<script src="../src/group.js"></script>
<script src="../src/grouping.js"></script>
<script src="../src/cluster-layout.js"></script>

<script>

var MIN_STUDENTS_PER_GROUP = 2;
var MAX_STUDENTS_PER_GROUP = Number.POSITIVE_INFINITY;

var classroom = new Classlist();
var layout = new ClusterLayout('svg');

/*load data from localStorage*/
var storedClassroom = localStorage.getItem('classroom');
if (storedClassroom != null){
  classroom.fromJSON(storedClassroom);
  console.log('loading classroom grom local storage', classroom.toString());
}

var storedStudentsPerGroup = parseInt(localStorage.getItem('students_per_group'));
if (storedStudentsPerGroup != null){
  $("#group_size_input").data('students_per_group', storedStudentsPerGroup);
  $("#group_size_input").attr('value', storedStudentsPerGroup);
} else {
  $("#group_size_input").data('students_per_group', MIN_STUDENTS_PER_GROUP);
  $("#group_size_input").attr('value', MIN_STUDENTS_PER_GROUP);
}

function updateLayout(layout, students, assignments){  
  layout.clear();
  for (var i = 0; i < students.length; i++) {
    layout.addNode(students[i].id(), students[i].name());
  }
  for (var i = 0; i < assignments.length; i++) {
    layout.addCluster(assignments[i].getStudentIDs());
  }
}

//create random pairs of students
var grouping = new Grouping(classroom);
var assignments = grouping.shuffle($("#group_size_input").data('students_per_group'));
var students = grouping.getStudents();
updateLayout(layout, students, assignments);

// console.log('assignments', assignments)
// console.log('students', students)
// console.log('studentsPerGroup', $("#group_size_input").data('students_per_group'))


var updateLocalStorage = function(grouping){
  localStorage.setItem('students_per_group', parseInt($("#group_size_input").data('students_per_group')));
  localStorage.setItem('grouping', grouping.toJSON());
}


//join event listener (for manual group updates)
$(layout).on('join', function(e) {
  console.log('adding', e.node, 'to', e.cluster);
  grouping.assignStudentToGroup(e.node, e.cluster);
  console.log('new grouping', grouping.toString());
  // updateLocalStorage(grouping) //todo when we reload grouping from disk
});

//shuffle listener
$('#shuffle_button').on('click', function(e) {
  var students_per_group  = $("#group_size_input").data('students_per_group')
  var assignments = grouping.shuffle(students_per_group);
  updateLayout(layout, students, assignments);
  updateLocalStorage(grouping);
});

/*group size input*/
updateStudentsPerGroup = function(new_students_per_group){
  console.log('updating students per group from '  + 
              $("#group_size_input").data('students_per_group')  +
              ' to ' + new_students_per_group);
  $("#group_size_input").data('students_per_group', new_students_per_group);
  $("#group_size_input").attr('value', new_students_per_group);
  updateLocalStorage(grouping);
}

$("#decrease_group_size").click(function(){
  var students_per_group = $("#group_size_input").data('students_per_group');
  var new_students_per_group = Math.max(students_per_group - 1, MIN_STUDENTS_PER_GROUP)
  if (new_students_per_group < students_per_group){
    updateStudentsPerGroup(new_students_per_group);
  }
})

$("#increase_group_size").click(function(){
  var students_per_group = $("#group_size_input").data('students_per_group');
  var new_students_per_group = Math.min(students_per_group + 1, MAX_STUDENTS_PER_GROUP);
  var new_students_per_group = Math.min(new_students_per_group, classroom.getSize());
  if (new_students_per_group > students_per_group){
    updateStudentsPerGroup(new_students_per_group);
  }
})
  
isValidStudentsPerGroup = function(group_size){
  var typeOK = (typeof group_size === 'number') && (group_size % 1 === 0);
  var sizeOK = (group_size >= MIN_STUDENTS_PER_GROUP) && (group_size <= MAX_STUDENTS_PER_GROUP);
  return typeOK && sizeOK
}

$("#group_size_input").on('focusout', function(){
  var new_students_per_group = parseInt($(this).val());
  if (isValidStudentsPerGroup(new_students_per_group)){
    updateStudentsPerGroup(new_students_per_group);
  } else {
    $(this).val($(this).data('students_per_group'));
  }
});

$("#group_size_input").on('input', function(e) {
  var charCode = e.which || e.keyCode;
  if (charCode == 13){
    var new_students_per_group = parseInt($(this).val());
    if (isValidStudentsPerGroup(new_students_per_group)){
      updateStudentsPerGroup(new_students_per_group);
    } else {
    $(this).val = $(this).data('students_per_group');
  }
    $('#group_size_input').blur();
  }
})

</script>

</body>
</html>
